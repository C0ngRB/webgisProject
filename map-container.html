<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS ç»¼åˆåœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.css" />
    <script src="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.cn.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* å³ä¸Šè§’æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            position: absolute; right: 60px; top: 15px; z-index: 1000;
            background: transparent; display: flex; gap: 10px;
        }
        .control-btn {
            width: 32px; height: 32px; background: white; color: #12513D;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 16px; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .control-btn:hover { background: #12513D; color: white; }
        
        /* é¡¶éƒ¨æœç´¢æ¡†æ ·å¼ */
        .search-box {
            position: absolute; left: 50%; top: 15px; transform: translateX(-50%); z-index: 1000;
        }
        .search-container { position: relative; display: inline-block; }
        .search-input {
            width: 200px; height: 32px; padding: 0 30px 0 10px;
            border: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-icon {
            position: absolute; right: 8px; top: 8px; color: #12513D; cursor: pointer;
        }

        /* === å·¦ä¸Šè§’è§†è§’åˆ‡æ¢å™¨æ ·å¼ === */
        .view-switcher {
            position: absolute; left: 60px; top: 15px; z-index: 1000;
            background: white; padding: 8px 12px; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px; color: #12513D; font-weight: bold;
            display: flex; gap: 15px; align-items: center;
        }
        .view-switcher label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* === å›¾ä¾‹æ ·å¼ (å›¢é˜Ÿæ¨¡å¼æ˜¾ç¤º) === */
        .legend {
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            display: none; /* é»˜è®¤éšè— */
            max-height: 250px; overflow-y: auto; width: 120px;
        }
        .legend h4 { margin: 0 0 8px 0; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 12px; }
        .color-box { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="view-switcher">
        <label><input type="radio" name="viewMode" value="personal" checked> ä¸ªäººè§†è§’</label>
        <label><input type="radio" name="viewMode" value="team"> å›¢é˜Ÿè§†è§’</label>
    </div>

    <div class="search-box">
        <div class="search-container">
            <input type="text" placeholder="æœç´¢åœ°ç‚¹..." class="search-input">
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>

    <div class="control-panel">
        <button class="control-btn" onclick="addFeature()" title="æ·»åŠ è¶³è¿¹"><i class="fas fa-plus"></i></button>
        <button class="control-btn" onclick="deleteFeature()" title="åˆ é™¤è¶³è¿¹"><i class="fas fa-trash-alt"></i></button>
        <button class="control-btn" onclick="modifyFeature()" title="ä¿®æ”¹è¶³è¿¹"><i class="fas fa-edit"></i></button>
        <button class="control-btn" onclick="queryFeature()" title="åˆ—è¡¨ç»Ÿè®¡"><i class="fas fa-list"></i></button>
    </div>

    <div id="legend" class="legend"></div>

    <div id="map"></div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // ä½ çš„ Render åç«¯åœ°å€
        const RENDER_HOST = "https://webgisproject.onrender.com"; 
        // ä½ çš„å¤©åœ°å›¾ Key
        const TDT_TK = "09b4ac8f49f3aeba74d8731519d21e3f";
        // ===========================================

        // 1. è·å–å½“å‰ç”¨æˆ·èº«ä»½ (ä» URL å‚æ•°ä¸­è·å– ?owner=xxx)
        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_USER = urlParams.get('owner') || 'è®¿å®¢';
        console.log("å½“å‰ç™»å½•ç”¨æˆ·:", CURRENT_USER);

        // 2. é¢œè‰²ç”Ÿæˆç®—æ³•ï¼šæ ¹æ®åå­—ç”Ÿæˆå›ºå®šé¢œè‰²
        function getColorByName(name) {
            if (!name) return '#999999';
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // ================= åœ°å›¾åˆå§‹åŒ– =================
        // å¤©åœ°å›¾å›¾å±‚
        const tdtVec = L.tileLayer(`http://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'], attribution: 'å¤©åœ°å›¾'
        });
        const tdtCva = L.tileLayer(`http://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });
        const tdtImg = L.tileLayer(`http://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'], attribution: 'å¤©åœ°å›¾å½±åƒ'
        });

        const vecGroup = L.layerGroup([tdtVec, tdtCva]);
        const imgGroup = L.layerGroup([tdtImg, tdtCva]);

        // åˆ›å»ºåœ°å›¾
        const map = L.map('map', {
            center: [30.59, 114.30], // é»˜è®¤æ­¦æ±‰
            zoom: 5,
            layers: [vecGroup],
            zoomControl: false
        });
        L.control.zoom({position: 'topleft'}).addTo(map);

        // æ§ä»¶ç»„
        L.control.layers({ "å¤©åœ°å›¾çŸ¢é‡": vecGroup, "å¤©åœ°å›¾å½±åƒ": imgGroup }).addTo(map);
        L.control.mousePosition({ position: 'bottomleft', prefix: "åæ ‡ï¼š" }).addTo(map);
        L.control.scale().addTo(map);
        
        // é‡ç®—å·¥å…·
        const measureControl = new L.Control.Measure({
            primaryLengthUnit: 'kilometers', secondaryLengthUnit: 'meters',
            primaryAreaUnit: 'sqmeters', activeColor: '#12513D', completedColor: '#12513D'
        });
        measureControl.addTo(map);

        // æ‹‰æ¡†æŸ¥è¯¢å·¥å…·
        const drawControl = new L.Control.Draw({
            draw: { polygon: false, marker: false, circle: false, polyline: false, circlemarker: false, rectangle: true },
            edit: false
        });
        map.addControl(drawControl);

        // ================= æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®åŠ è½½ä¸å±•ç¤º =================
        let markersLayer = L.layerGroup().addTo(map);
        let queryLayer = L.layerGroup().addTo(map); // æ‹‰æ¡†ç»“æœå±‚
        let currentMode = 'personal'; // é»˜è®¤ä¸ªäººè§†è§’

        function loadPoints() {
            markersLayer.clearLayers();
            const legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = '<h4>æˆå‘˜å›¾ä¾‹</h4>';
            let ownersSet = new Set(); 

            // æ„å»ºè¯·æ±‚ API
            let api = `${RENDER_HOST}/searchtravelpoints`;
            if (currentMode === 'personal') {
                api += `?owner=${encodeURIComponent(CURRENT_USER)}`;
            }

            fetch(api)
                .then(res => res.json())
                .then(data => {
                    data.forEach(point => {
                        // 1. ç¡®å®šé¢œè‰²
                        let color = '#12513D'; // ä¸ªäººè§†è§’é»˜è®¤ç»¿è‰²
                        if (currentMode === 'team') {
                            color = getColorByName(point.owner);
                            ownersSet.add(point.owner || 'æœªçŸ¥');
                        }

                        // 2. åˆ›å»ºç‚¹
                        const marker = L.circleMarker([point.lat, point.lon], {
                            color: 'white',       // è¾¹æ¡†ç™½
                            fillColor: color,     // å¡«å……è‰²
                            fillOpacity: 0.9,
                            weight: 2,
                            radius: 8
                        }).addTo(markersLayer);

                        // 3. ç»‘å®šå¼¹çª—å†…å®¹
                        const timeStr = point.time ? point.time.replace('T', ' ').substring(0, 16) : 'å†å²æ•°æ®';
                        const popupContent = `
                            <div style="min-width:160px; font-family:Arial;">
                                <h3 style="margin:0 0 8px 0; color:${color}; border-bottom:1px solid #eee; padding-bottom:5px;">
                                    ${point.name}
                                </h3>
                                <div style="margin-bottom:8px; font-size:13px;">${point.info || 'æš‚æ— å¤‡æ³¨'}</div>
                                <div style="background:#f5f5f5; padding:5px; border-radius:4px; font-size:12px; color:#666;">
                                    <div>ğŸ‘¤ <span style="font-weight:bold">${point.owner || 'æœªçŸ¥'}</span></div>
                                    <div style="margin-top:2px;">ğŸ•’ ${timeStr}</div>
                                </div>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    });

                    // 4. ç”Ÿæˆå›¾ä¾‹ (ä»…å›¢é˜Ÿæ¨¡å¼)
                    if (currentMode === 'team' && ownersSet.size > 0) {
                        legendDiv.style.display = 'block';
                        ownersSet.forEach(owner => {
                            const c = getColorByName(owner);
                            legendDiv.innerHTML += `
                                <div class="legend-item">
                                    <div class="color-box" style="background:${c}"></div>
                                    <span>${owner}</span>
                                </div>
                            `;
                        });
                    } else {
                        legendDiv.style.display = 'none';
                    }
                })
                .catch(err => console.error("åŠ è½½æ•°æ®å¤±è´¥:", err));
        }

        // ç›‘å¬è§†è§’åˆ‡æ¢
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMode = e.target.value;
                loadPoints();
            });
        });

        // åˆå§‹åŠ è½½
        loadPoints();

        // ================= å¢åˆ æ”¹æŸ¥äº¤äº’é€»è¾‘ =================
        let activeIframe = null;
        let clickHandler = null;
        let modifyMarkers = [];
        let searchMarkers = [];

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»º iframe
        function createIframe(src, height, width=250) {
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.position = 'absolute'; iframe.style.right = '10px'; iframe.style.top = '60px';
            iframe.style.width = width + 'px'; iframe.style.height = height + 'px';
            iframe.style.border = 'none'; iframe.style.borderRadius = '8px';
            iframe.style.zIndex = '2000'; iframe.style.background = 'white';
            iframe.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
            return iframe;
        }

        function closeActiveForm() {
            if(activeIframe) { activeIframe.remove(); activeIframe = null; }
            modifyMarkers.forEach(m => map.removeLayer(m));
            modifyMarkers = [];
            searchMarkers.forEach(m => map.removeLayer(m));
            searchMarkers = [];
            if (clickHandler) {
                map.off('click', clickHandler);
                clickHandler = null;
            }
            document.getElementById('map').style.cursor = '';
        }

        // 1. æ·»åŠ åŠŸèƒ½
        function addFeature() {
            closeActiveForm();
            // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦åœ¨URLä¼ ownerï¼Œè€Œæ˜¯é€šè¿‡ postMessage ä¼ 
            const iframe = createIframe('feature-form.html', 300);
            document.body.appendChild(iframe);
            activeIframe = iframe;

            // Iframe åŠ è½½å®Œæˆåï¼Œå‘Šè¯‰å®ƒå½“å‰ç”¨æˆ·æ˜¯è°
            iframe.onload = function() {
                iframe.contentWindow.postMessage({
                    type: 'setOwner',
                    owner: CURRENT_USER
                }, '*');
            };
            
            document.getElementById('map').style.cursor = 'crosshair';
            
            const mouseMoveHandler = function(e) {
                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'setCoordinates', lat: e.latlng.lat, lng: e.latlng.lng
                    }, '*');
                }
            };
            
            clickHandler = function(e) {
                document.getElementById('map').style.cursor = '';
                map.off('mousemove', mouseMoveHandler);
                map.off('click', clickHandler);
                clickHandler = null;
            };
            
            map.on('mousemove', mouseMoveHandler);
            map.on('click', clickHandler);
        }

        // 2. åˆ é™¤åŠŸèƒ½
        function deleteFeature() {
            closeActiveForm();
            // è·å–åˆ—è¡¨ (å»ºè®®è¿™é‡Œä¹Ÿæ ¹æ® currentMode å†³å®šæ˜¯å¦åªèƒ½åˆ è‡ªå·±çš„ï¼Œæš‚æ—¶å…ˆæŸ¥å…¨éƒ¨)
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    // å¦‚æœæ˜¯ä¸ªäººæ¨¡å¼ï¼Œåªç­›é€‰å‡ºè‡ªå·±çš„ç‚¹ä¾›åˆ é™¤
                    let pointsToShow = data;
                    if(currentMode === 'personal') {
                        pointsToShow = data.filter(p => p.owner === CURRENT_USER);
                    }
                    
                    const iframe = createIframe('travel-points-table.html', 400, 350);
                    document.body.appendChild(iframe);
                    activeIframe = iframe;
                    iframe.onload = function() {
                        iframe.contentWindow.postMessage({ type: 'setTravelPoints', points: pointsToShow }, '*');
                    };
                });
        }

        // 3. ä¿®æ”¹åŠŸèƒ½
        function modifyFeature() {
            closeActiveForm();
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    let count = 0;
                    data.forEach(point => {
                        // åªèƒ½ä¿®æ”¹è‡ªå·±çš„ç‚¹
                        if (point.owner !== CURRENT_USER && point.owner !== undefined) return;

                        count++;
                        const marker = L.circleMarker([point.lat, point.lon], { 
                            color: '#FF9900', radius: 10, fillOpacity: 0.5 
                        }).addTo(map);
                        modifyMarkers.push(marker);
                        
                        marker.on('click', function() {
                            modifyMarkers.forEach(m => { if(m!==marker) map.removeLayer(m); });
                            modifyMarkers = [marker];
                            
                            if(activeIframe) activeIframe.remove();
                            const iframe = createIframe('modify-form.html', 300);
                            document.body.appendChild(iframe);
                            activeIframe = iframe;
                            iframe.onload = function() {
                                iframe.contentWindow.postMessage({ type: 'setModifyData', point: point }, '*');
                            };
                        });
                    });
                    
                    if(count === 0) alert("æ²¡æœ‰æ‰¾åˆ°å±äºä½ çš„è¶³è¿¹ç‚¹ï¼ˆæ— æ³•ä¿®æ”¹ä»–äººçš„ç‚¹ï¼‰ã€‚");
                    else alert("è¯·ç‚¹å‡»åœ°å›¾ä¸Šçš„æ©™è‰²å…‰åœˆè¿›è¡Œä¿®æ”¹");
                });
        }

        // 4. åˆ—è¡¨ç»Ÿè®¡
        function queryFeature() {
            closeActiveForm();
            let api = `${RENDER_HOST}/searchtravelpoints`;
            if (currentMode === 'personal') api += `?owner=${encodeURIComponent(CURRENT_USER)}`;

            fetch(api).then(res => res.json()).then(data => {
                const iframe = createIframe('stats-table.html', 400, 500);
                document.body.appendChild(iframe);
                activeIframe = iframe;
                iframe.onload = function() {
                    iframe.contentWindow.postMessage({ type: 'setStatsData', points: data }, '*');
                };
            });
        }

        // 5. æ‹‰æ¡†æŸ¥è¯¢
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            const bounds = layer.getBounds();
            queryLayer.clearLayers();
            queryLayer.addLayer(layer);

            const minLat = bounds.getSouth();
            const maxLat = bounds.getNorth();
            const minLon = bounds.getWest();
            const maxLon = bounds.getEast();

            fetch(`${RENDER_HOST}/query-bbox?minLon=${minLon}&minLat=${minLat}&maxLon=${maxLon}&maxLat=${maxLat}`)
                .then(res => res.json())
                .then(data => {
                    alert(`æŸ¥è¯¢åŒºåŸŸå†…å…±æœ‰ ${data.length} ä¸ªè¶³è¿¹ç‚¹ï¼`);
                    data.forEach(point => {
                        const color = getColorByName(point.owner);
                        L.circleMarker([point.lat, point.lon], { color: 'red', fillColor: color, radius: 6 })
                         .addTo(queryLayer)
                         .bindPopup(`<b>${point.name}</b><br>è®°å½•äºº: ${point.owner || 'æœªçŸ¥'}`)
                         .openPopup();
                    });
                });
        });

        // 6. æœç´¢åŠŸèƒ½
        document.querySelector('.search-icon').addEventListener('click', function() {
            const val = document.querySelector('.search-input').value;
            if(!val) return;
            fetch(`${RENDER_HOST}/searchtravelpoints?name=${encodeURIComponent(val)}`)
                .then(res => res.json())
                .then(data => {
                    searchMarkers.forEach(m => map.removeLayer(m));
                    searchMarkers = [];
                    if(data.length === 0) { alert('æœªæ‰¾åˆ°'); return; }
                    data.forEach(p => {
                        const m = L.marker([p.lat, p.lon]).addTo(map)
                            .bindPopup(`<b>${p.name}</b><br>${p.info}`).openPopup();
                        searchMarkers.push(m);
                    });
                    map.setView([data[0].lat, data[0].lon], 10);
                });
        });

        // æ¶ˆæ¯ç›‘å¬
        window.addEventListener('message', function(event) {
            if (event.data.type === 'closeForm') closeActiveForm();
            if (event.data.type === 'reloadParentPage') {
                loadPoints(); 
                closeActiveForm();
            }
        });

    </script>
</body>
</html>
