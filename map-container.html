<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS 综合地图</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.css" />
    <script src="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.cn.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* 控制面板样式 */
        .control-panel {
            position: absolute; right: 60px; top: 15px; z-index: 1000;
            background: transparent; display: flex; gap: 10px;
        }
        .control-btn {
            width: 32px; height: 32px; background: white; color: #12513D;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 16px; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .control-btn:hover { background: #12513D; color: white; }
        
        /* 搜索框样式 */
        .search-box {
            position: absolute; left: 50%; top: 15px; transform: translateX(-50%); z-index: 1000;
        }
        .search-container { position: relative; display: inline-block; }
        .search-input {
            width: 200px; height: 32px; padding: 0 30px 0 10px;
            border: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-icon {
            position: absolute; right: 8px; top: 8px; color: #12513D; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="search-box">
        <div class="search-container">
            <input type="text" placeholder="搜索地点..." class="search-input">
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>

    <div class="control-panel">
        <button class="control-btn" onclick="addFeature()" title="添加足迹"><i class="fas fa-plus"></i></button>
        <button class="control-btn" onclick="deleteFeature()" title="删除足迹"><i class="fas fa-trash-alt"></i></button>
        <button class="control-btn" onclick="modifyFeature()" title="修改足迹"><i class="fas fa-edit"></i></button>
        <button class="control-btn" onclick="queryFeature()" title="列表统计"><i class="fas fa-list"></i></button>
    </div>

    <div id="map"></div>

    <script>
        // ================= 配置区域 =================
        // 1. 你的 Render 后端地址 (注意是 https)
        const RENDER_HOST = "https://webgisproject.onrender.com"; 
        // 2. 你的天地图 Key
        const TDT_TK = "09b4ac8f49f3aeba74d8731519d21e3f";
        // ===========================================

        // 初始化底图 (天地图)
        const tdtVec = L.tileLayer(`http://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'], attribution: '天地图'
        });
        const tdtCva = L.tileLayer(`http://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });
        const tdtImg = L.tileLayer(`http://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'], attribution: '天地图影像'
        });

        const vecGroup = L.layerGroup([tdtVec, tdtCva]);
        const imgGroup = L.layerGroup([tdtImg, tdtCva]);

        // 初始化地图
        const map = L.map('map', {
            center: [30.59, 114.30], // 默认武汉
            zoom: 5,
            layers: [vecGroup],
            zoomControl: false // 隐藏默认缩放控件，后面可以自己加或者用默认位置
        });
        L.control.zoom({position: 'topleft'}).addTo(map);

        // 1. 图层切换控件 (解决要求：底图切换)
        const baseLayers = { "天地图矢量": vecGroup, "天地图影像": imgGroup };
        L.control.layers(baseLayers).addTo(map);

        // 2. 鼠标坐标控件
        L.control.mousePosition({ position: 'bottomleft', prefix: "坐标：" }).addTo(map);

        // 3. 比例尺
        L.control.scale().addTo(map);

        // 4. 量算工具 (解决要求：量算功能)
        const measureControl = new L.Control.Measure({
            primaryLengthUnit: 'kilometers', secondaryLengthUnit: 'meters',
            primaryAreaUnit: 'sqmeters', activeColor: '#12513D', completedColor: '#12513D'
        });
        measureControl.addTo(map);

        // 5. 拉框查询工具 (解决要求：空间查询)
        const drawControl = new L.Control.Draw({
            draw: { polygon: false, marker: false, circle: false, polyline: false, circlemarker: false, rectangle: true },
            edit: false
        });
        map.addControl(drawControl);

        // 结果显示图层
        let queryLayer = L.layerGroup().addTo(map);
        let markersLayer = L.layerGroup().addTo(map); // 存放普通加载的点

        // 监听拉框完成事件
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            const bounds = layer.getBounds();
            queryLayer.clearLayers();
            queryLayer.addLayer(layer); // 显示框

            const minLat = bounds.getSouth();
            const maxLat = bounds.getNorth();
            const minLon = bounds.getWest();
            const maxLon = bounds.getEast();

            // 调用后端拉框接口
            fetch(`${RENDER_HOST}/query-bbox?minLon=${minLon}&minLat=${minLat}&maxLon=${maxLon}&maxLat=${maxLat}`)
                .then(res => res.json())
                .then(data => {
                    alert(`查询到 ${data.length} 个足迹点！`);
                    data.forEach(point => {
                        L.circleMarker([point.lat, point.lon], { color: 'red', radius: 8 })
                         .addTo(queryLayer)
                         .bindPopup(`<b>${point.name}</b><br>${point.info}<br><small>记录人: ${point.owner || '未知'}</small>`)
                         .openPopup();
                    });
                })
                .catch(err => {
                    console.error(err);
                    alert("查询失败，请检查后端是否启动");
                });
        });

        // ================= 原有业务逻辑 (增删改查) =================
        let clickHandler = null;
        let modifyMarkers = [];
        let searchMarkers = [];

        // 加载所有点
        function loadAllPoints() {
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    markersLayer.clearLayers();
                    data.forEach(point => {
                        L.marker([point.lat, point.lon]).addTo(markersLayer)
                         .bindPopup(`<b>${point.name}</b><br>${point.info}`);
                    });
                });
        }
        // 页面加载时自动加载点
        loadAllPoints();

        // 添加功能
        function addFeature() {
            clearForms();
            const formContainer = createIframe('feature-form.html', 300);
            document.getElementById('map').appendChild(formContainer);
            
            document.getElementById('map').style.cursor = 'crosshair';
            
            const mouseMoveHandler = function(e) {
                if (formContainer.contentWindow) {
                    formContainer.contentWindow.postMessage({
                        type: 'setCoordinates', lat: e.latlng.lat, lng: e.latlng.lng
                    }, '*');
                }
            };
            
            clickHandler = function(e) {
                document.getElementById('map').style.cursor = '';
                map.off('click', clickHandler);
                map.off('mousemove', mouseMoveHandler);
            };
            
            map.on('mousemove', mouseMoveHandler);
            map.on('click', clickHandler);
        }

        // 删除功能
        function deleteFeature() {
            clearForms();
            // 先弹出一个简单的选择框 (这里简化逻辑，直接调用后端获取列表)
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    const formContainer = createIframe('travel-points-table.html', 400, 350);
                    document.getElementById('map').appendChild(formContainer);
                    formContainer.onload = function() {
                        formContainer.contentWindow.postMessage({ type: 'setTravelPoints', points: data }, '*');
                    };
                });
        }

        // 列表统计
        function queryFeature() {
            clearForms();
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    const formContainer = createIframe('stats-table.html', 400, 500);
                    document.getElementById('map').appendChild(formContainer);
                    formContainer.onload = function() {
                        formContainer.contentWindow.postMessage({ type: 'setStatsData', points: data }, '*');
                    };
                });
        }

        // 修改功能
        function modifyFeature() {
            clearForms();
            fetch(`${RENDER_HOST}/searchtravelpoints`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(point => {
                        const marker = L.circleMarker([point.lat, point.lon], { color: 'orange', radius: 8 }).addTo(map);
                        modifyMarkers.push(marker);
                        marker.on('click', function() {
                            // 清除其他标记只留这个
                            modifyMarkers.forEach(m => { if(m!==marker) map.removeLayer(m); });
                            modifyMarkers = [marker];
                            
                            const formContainer = createIframe('modify-form.html', 300);
                            document.getElementById('map').appendChild(formContainer);
                            formContainer.onload = function() {
                                formContainer.contentWindow.postMessage({ type: 'setModifyData', point: point }, '*');
                            };
                        });
                    });
                    alert("请点击地图上的橙色点进行修改");
                });
        }

        // 辅助函数：创建iframe
        function createIframe(src, height, width=250) {
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.className = 'popup-form';
            iframe.style.position = 'absolute';
            iframe.style.right = '10px';
            iframe.style.top = '60px';
            iframe.style.width = width + 'px';
            iframe.style.height = height + 'px';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.style.zIndex = '2000';
            iframe.style.background = 'white';
            iframe.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
            iframe.id = 'active-form';
            return iframe;
        }

        // 清除所有表单和临时标记
        function clearForms() {
            const form = document.getElementById('active-form');
            if (form) form.remove();
            modifyMarkers.forEach(m => map.removeLayer(m));
            modifyMarkers = [];
            if (clickHandler) {
                map.off('click', clickHandler);
                clickHandler = null;
            }
            document.getElementById('map').style.cursor = '';
        }

        // 监听 iframe 发来的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'closeForm') {
                clearForms();
            }
            if (event.data.type === 'reloadParentPage') {
                loadAllPoints(); // 刷新数据而不是刷新页面
                clearForms();
            }
            // 之前的 addMarker 逻辑
            if(event.data.type === 'addMarker') {
                L.circleMarker([event.data.marker.lat, event.data.marker.lng], {
                    color: '#12513D', radius: 5
                }).addTo(map);
            }
        });

        // 搜索功能
        document.querySelector('.search-icon').addEventListener('click', function() {
            const val = document.querySelector('.search-input').value;
            if(!val) return;
            fetch(`${RENDER_HOST}/searchtravelpoints?name=${encodeURIComponent(val)}`)
                .then(res => res.json())
                .then(data => {
                    searchMarkers.forEach(m => map.removeLayer(m));
                    searchMarkers = [];
                    if(data.length === 0) { alert('未找到'); return; }
                    data.forEach(p => {
                        const m = L.marker([p.lat, p.lon]).addTo(map).bindPopup(p.name).openPopup();
                        searchMarkers.push(m);
                    });
                    map.setView([data[0].lat, data[0].lon], 10);
                });
        });
    </script>
</body>
</html>
