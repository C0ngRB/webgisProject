<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS ç»¼åˆåœ°å›¾</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.css" />
    <script src="https://cdn.jsdelivr.net/gh/ardhi/Leaflet.MousePosition/src/L.Control.MousePosition.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.cn.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* å³ä¸Šè§’æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            position: absolute; right: 60px; top: 15px; z-index: 1000;
            background: transparent; display: flex; gap: 10px;
        }
        .control-btn {
            width: 32px; height: 32px; background: white; color: #12513D;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 16px; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .control-btn:hover { background: #12513D; color: white; }
        
        /* é¡¶éƒ¨æœç´¢æ¡†æ ·å¼ */
        .search-box {
            position: absolute; left: 50%; top: 15px; transform: translateX(-50%); z-index: 1000;
        }
        .search-container { position: relative; display: inline-block; }
        .search-input {
            width: 200px; height: 32px; padding: 0 30px 0 10px;
            border: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-icon {
            position: absolute; right: 8px; top: 8px; color: #12513D; cursor: pointer;
        }

        /* === å·¦ä¸Šè§’è§†è§’åˆ‡æ¢å™¨æ ·å¼ === */
        .view-switcher {
            position: absolute; left: 60px; top: 15px; z-index: 1000;
            background: white; padding: 8px 12px; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px; color: #12513D; font-weight: bold;
            display: flex; gap: 15px; align-items: center;
        }
        .view-switcher label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* === å›¾ä¾‹æ ·å¼ (å›¢é˜Ÿæ¨¡å¼æ˜¾ç¤º) === */
        .legend {
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: absolute; bottom: 30px; right: 10px; z-index: 1000;
            display: none; /* é»˜è®¤éšè— */
            max-height: 250px; overflow-y: auto; width: 120px;
        }
        .legend h4 { margin: 0 0 8px 0; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 12px; }
        .color-box { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="view-switcher">
        <label><input type="radio" name="viewMode" value="personal" checked> ä¸ªäººè§†è§’</label>
        <label><input type="radio" name="viewMode" value="team"> å›¢é˜Ÿè§†è§’</label>
    </div>

    <div class="search-box">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="æœç´¢åœ°ç‚¹..." class="search-input">
            <i class="fas fa-search search-icon" id="searchBtn"></i>
        </div>
    </div>

    <div class="control-panel">
        <button class="control-btn" onclick="addFeature()" title="æ·»åŠ è¶³è¿¹"><i class="fas fa-plus"></i></button>
        <button class="control-btn" onclick="deleteFeature()" title="åˆ é™¤è¶³è¿¹"><i class="fas fa-trash-alt"></i></button>
        <button class="control-btn" onclick="modifyFeature()" title="ä¿®æ”¹è¶³è¿¹"><i class="fas fa-edit"></i></button>
        <button class="control-btn" onclick="queryFeature()" title="åˆ—è¡¨ç»Ÿè®¡"><i class="fas fa-list"></i></button>
    </div>

    <div id="legend" class="legend"></div>

    <div id="map"></div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const RENDER_HOST = "https://webgisproject.onrender.com"; 
        const TDT_TK = "09b4ac8f49f3aeba74d8731519d21e3f";
        // ===========================================

        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_USER = urlParams.get('owner') || 'è®¿å®¢';

        function getColorByName(name) {
            if (!name) return '#999999';
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // ================= åœ°å›¾åˆå§‹åŒ–ä¸ç“¦ç‰‡åŠŸèƒ½ =================
        
        // 1. å¤©åœ°å›¾å›¾å±‚
        const tdtVec = L.tileLayer(`http://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: '01234567', attribution: 'å¤©åœ°å›¾çŸ¢é‡'
        });
        const tdtCva = L.tileLayer(`http://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: '01234567'
        });
        const tdtImg = L.tileLayer(`http://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDT_TK}`, {
            subdomains: '01234567', attribution: 'å¤©åœ°å›¾å½±åƒ'
        });

        // 2. ã€æ–°å¢ã€‘æ­¦æ±‰å¤§å­¦ä¸“ç”¨ç“¦ç‰‡å±‚ï¼ˆä½œä¸ºä¸“é¢˜åº•å›¾åˆ‡æ¢åŠŸèƒ½ï¼‰
        const whuCampusLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: 'WHU Campus Map'
        });

        const vecGroup = L.layerGroup([tdtVec, tdtCva]);
        const imgGroup = L.layerGroup([tdtImg, tdtCva]);
        const whuGroup = L.layerGroup([whuCampusLayer, tdtCva]);

        // 3. ã€æ–°å¢ã€‘è¡—åŒºæ•°æ®å›¾å±‚ï¼ˆGeoJSONï¼‰
        let whuBlockLayer = L.geoJSON(null, {
            style: { color: "#12513D", weight: 2, fillOpacity: 0.1 },
            onEachFeature: function(feature, layer) {
                layer.bindPopup("è¡—åŒºåç§°: " + (feature.properties.name || "WHU è¡—åŒº"));
            }
        });

        // åˆ›å»ºåœ°å›¾ï¼Œé»˜è®¤å®šä½åˆ°æ­¦æ±‰å¤§å­¦
        const map = L.map('map', {
            center: [30.54, 114.36], 
            zoom: 15,
            layers: [whuGroup],
            zoomControl: false
        });
        L.control.zoom({position: 'topleft'}).addTo(map);

        // 4. å›¾å±‚åˆ‡æ¢æ§ä»¶ï¼ˆæ•´åˆåˆ°åº•å›¾åˆ‡æ¢ä¸­ï¼‰
        const baseLayers = {
            "æ­¦å¤§ä¸“é¢˜ç“¦ç‰‡": whuGroup,
            "å¤©åœ°å›¾çŸ¢é‡": vecGroup,
            "å¤©åœ°å›¾å½±åƒ": imgGroup
        };

        let markersLayer = L.layerGroup().addTo(map);
        const overlays = {
            "æ­¦æ±‰è¡—åŒºæ•°æ® (GeoJSON)": whuBlockLayer,
            "è¶³è¿¹ç‚¹": markersLayer
        };

        L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

        // è‡ªåŠ¨åŠ è½½è¡—åŒº GeoJSON æ•°æ®
        fetch('https://raw.githubusercontent.com/clemsos/whu-gis/master/data/whu.geojson')
            .then(res => res.json()).then(data => whuBlockLayer.addData(data)).catch(e => console.log("GeoJSONåŠ è½½å¤±è´¥"));

        // åŸºç¡€æ§ä»¶
        L.control.mousePosition({ position: 'bottomleft', prefix: "åæ ‡ï¼š" }).addTo(map);
        L.control.scale().addTo(map);
        new L.Control.Measure({
            primaryLengthUnit: 'kilometers', activeColor: '#12513D', completedColor: '#12513D'
        }).addTo(map);

        const drawControl = new L.Control.Draw({
            draw: { rectangle: true, polygon: false, marker: false, circle: false, polyline: false, circlemarker: false },
            edit: false
        });
        map.addControl(drawControl);

        // ================= ä¸šåŠ¡é€»è¾‘ =================
        let queryLayer = L.layerGroup().addTo(map);
        let currentMode = 'personal';

        function loadPoints() {
            markersLayer.clearLayers();
            const legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = '<h4>æˆå‘˜å›¾ä¾‹</h4>';
            let ownersSet = new Set(); 

            let api = `${RENDER_HOST}/searchtravelpoints`;
            if (currentMode === 'personal') api += `?owner=${encodeURIComponent(CURRENT_USER)}`;

            fetch(api).then(res => res.json()).then(data => {
                data.forEach(point => {
                    let color = '#12513D'; 
                    if (currentMode === 'team') {
                        color = getColorByName(point.owner);
                        ownersSet.add(point.owner || 'æœªçŸ¥');
                    }

                    const marker = L.circleMarker([point.lat, point.lon], {
                        color: 'white', fillColor: color, fillOpacity: 0.9, weight: 2, radius: 8
                    }).addTo(markersLayer);

                    const timeStr = point.time ? point.time.replace('T', ' ').substring(0, 16) : 'å†å²æ•°æ®';
                    marker.bindPopup(`
                        <div style="min-width:160px; font-family:Arial;">
                            <h3 style="margin:0 0 8px 0; color:${color}; border-bottom:1px solid #eee; padding-bottom:5px;">${point.name}</h3>
                            <div style="margin-bottom:8px; font-size:13px;">${point.info || 'æš‚æ— å¤‡æ³¨'}</div>
                            <div style="background:#f5f5f5; padding:5px; border-radius:4px; font-size:12px; color:#666;">
                                <div>ğŸ‘¤ <span style="font-weight:bold">${point.owner || 'æœªçŸ¥'}</span></div>
                                <div style="margin-top:2px;">ğŸ•’ ${timeStr}</div>
                            </div>
                        </div>
                    `);
                });

                if (currentMode === 'team' && ownersSet.size > 0) {
                    legendDiv.style.display = 'block';
                    ownersSet.forEach(owner => {
                        legendDiv.innerHTML += `<div class="legend-item"><div class="color-box" style="background:${getColorByName(owner)}"></div><span>${owner}</span></div>`;
                    });
                } else legendDiv.style.display = 'none';
            });
        }

        // äº¤äº’åŠŸèƒ½
        let activeIframe = null;

        function createIframe(src, height, width=250) {
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style = `position:absolute; right:10px; top:60px; width:${width}px; height:${height}px; border:none; border-radius:8px; z-index:2000; background:white; box-shadow:0 0 10px rgba(0,0,0,0.2);`;
            return iframe;
        }

        function closeActiveForm() {
            if(activeIframe) { activeIframe.remove(); activeIframe = null; }
            document.getElementById('map').style.cursor = '';
        }

        function addFeature() {
            closeActiveForm();
            const iframe = createIframe('feature-form.html', 300);
            document.body.appendChild(iframe);
            activeIframe = iframe;
            iframe.onload = () => iframe.contentWindow.postMessage({ type: 'setOwner', owner: CURRENT_USER }, '*');
            document.getElementById('map').style.cursor = 'crosshair';
            map.once('click', e => {
                iframe.contentWindow.postMessage({ type: 'setCoordinates', lat: e.latlng.lat, lng: e.latlng.lng }, '*');
                document.getElementById('map').style.cursor = '';
            });
        }

        function deleteFeature() {
            closeActiveForm();
            fetch(`${RENDER_HOST}/searchtravelpoints`).then(res => res.json()).then(data => {
                let pts = currentMode === 'personal' ? data.filter(p => p.owner === CURRENT_USER) : data;
                const iframe = createIframe('travel-points-table.html', 400, 350);
                document.body.appendChild(iframe);
                activeIframe = iframe;
                iframe.onload = () => iframe.contentWindow.postMessage({ type: 'setTravelPoints', points: pts }, '*');
            });
        }

        function modifyFeature() {
            alert("è¯·ç‚¹å‡»æ©™è‰²åœ†åœˆç‚¹è¿›è¡Œä¿®æ”¹");
            loadPoints(); // åˆ·æ–°ç‚¹
        }

        function queryFeature() {
            closeActiveForm();
            fetch(`${RENDER_HOST}/searchtravelpoints`).then(res => res.json()).then(data => {
                const iframe = createIframe('stats-table.html', 400, 500);
                document.body.appendChild(iframe);
                activeIframe = iframe;
                iframe.onload = () => iframe.contentWindow.postMessage({ type: 'setStatsData', points: data }, '*');
            });
        }

        // ç©ºé—´æŸ¥è¯¢
        map.on(L.Draw.Event.CREATED, function (e) {
            const b = e.layer.getBounds();
            queryLayer.clearLayers().addLayer(e.layer);
            fetch(`${RENDER_HOST}/query-bbox?minLon=${b.getWest()}&minLat=${b.getSouth()}&maxLon=${b.getEast()}&maxLat=${b.getNorth()}`)
                .then(res => res.json()).then(data => {
                    alert(`æŸ¥è¯¢åŒºåŸŸå†…å…±æœ‰ ${data.length} ä¸ªè¶³è¿¹ç‚¹ï¼`);
                    data.forEach(p => L.circleMarker([p.lat, p.lon], { color: 'red', radius: 6 }).addTo(queryLayer));
                });
        });

        // æœç´¢
        document.getElementById('searchBtn').onclick = () => {
            const val = document.getElementById('searchInput').value;
            if(!val) return;
            fetch(`${RENDER_HOST}/searchtravelpoints?name=${encodeURIComponent(val)}`)
                .then(res => res.json()).then(data => {
                    if(data.length > 0) map.setView([data[0].lat, data[0].lon], 12);
                    else alert('æœªæ‰¾åˆ°');
                });
        };

        document.querySelectorAll('input[name="viewMode"]').forEach(r => r.onchange = e => { currentMode = e.target.value; loadPoints(); });
        
        window.addEventListener('message', function(event) {
            if (event.data.type === 'closeForm') closeActiveForm();
            if (event.data.type === 'reloadParentPage') { loadPoints(); closeActiveForm(); }
        });

        loadPoints();
    </script>
</body>
</html>
