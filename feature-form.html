<!DOCTYPE html>
<html>
  <head>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden; /* 隐藏滚动条 */
      }
      #feature-form {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        box-sizing: border-box; /* 包含padding在内的高度计算 */
        display: flex;
        flex-direction: column;
      }
      .form-group {
        margin-bottom: 10px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .form-group textarea {
        flex: 1;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
      }
      .form-group textarea {
        height: 80px;
      }
      .form-buttons {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }
      .form-buttons button {
        flex: 1;
        padding: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .submit-btn {
        background: #12513d;
        color: white;
      }
      .cancel-btn {
        background: #ccc;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div id="feature-form">
      <!-- 修改为单选按钮形式 -->
      <div class="form-group" style="flex: 0; margin-bottom: 0px">
        <!-- 减少下边距 -->
        <div style="display: flex; gap: 15px; justify-content: center">
          <label style="display: flex; align-items: center; font-size: 13px">
            <!-- 减小字体 -->
            <input
              type="radio"
              name="featureType"
              value="point"
              checked
              style="margin-right: 5px"
            />
            点
          </label>
          <label style="display: flex; align-items: center; font-size: 13px">
            <!-- 减小字体 -->
            <input
              type="radio"
              name="featureType"
              value="line"
              style="margin-right: 5px"
            />
            线
          </label>
        </div>
      </div>

      <!-- 点表单部分 -->
      <div id="pointForm">
        <div class="form-group">
          <label>坐标：</label>
          <input type="text" id="coordInput" readonly />
        </div>
        <div class="form-group">
          <div style="display: flex; gap: 10px">
            <div style="flex: 1">
              <label>省份：</label>
              <input type="text" id="provinceInput" />
            </div>
            <div style="flex: 1">
              <label>城市：</label>
              <input type="text" id="cityInput" />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>备注：</label>
          <textarea id="noteInput"></textarea>
        </div>
      </div>

      <!-- 线表单部分 (默认隐藏) -->
      <div id="lineForm" style="display: none">
        <div class="form-group">
          <div style="display: flex; align-items: center; gap: 10px">
            <label style="white-space: nowrap">起点：</label>
            <input
              type="text"
              id="startNameInput"
              placeholder="起点名称"
              style="flex: 1"
            />
          </div>
          <div style="margin-top: 5px">
            <label>坐标：</label>
            <input
              type="text"
              id="startCoordInput"
              readonly
              placeholder="请选择起点"
              style="width: 100%"
            />
          </div>
        </div>
        <div class="form-group">
          <div style="display: flex; align-items: center; gap: 10px">
            <label style="white-space: nowrap">终点：</label>
            <input
              type="text"
              id="endNameInput"
              placeholder="终点名称"
              style="flex: 1"
            />
          </div>
          <div style="margin-top: 5px">
            <label>坐标：</label>
            <input
              type="text"
              id="endCoordInput"
              readonly
              placeholder="请选择终点"
              style="width: 100%"
            />
          </div>
        </div>
      </div>

      <div class="form-buttons">
        <button class="submit-btn" id="submitBtn">完成</button>
        <button class="cancel-btn" id="cancelBtn">取消</button>
      </div>
    </div>
    <script>
      // 修改类型切换事件监听
      document
        .querySelectorAll('input[name="featureType"]')
        .forEach((radio) => {
          radio.addEventListener("change", function () {
            const isLine = this.value === "line";
            document.getElementById("pointForm").style.display = isLine
              ? "none"
              : "block";
            document.getElementById("lineForm").style.display = isLine
              ? "block"
              : "none";

            if (isLine) {
              initLineForm();
            }
          });
        });

      // 初始化线表单
      async function initLineForm() {
        try {
          // 获取所有点数据
          const response = await fetch(
            "https://webgisproject.onrender.com/searchtravelpoints"
          );
          const points = await response.json();

          // 通知父窗口绘制所有点
          window.parent.postMessage(
            {
              type: "drawPointsForLine",
              points: points,
            },
            "*"
          );

          // 设置选择起点状态
          setSelectionMode("start");

          // 初始化文本框提示文字
        } catch (err) {
          console.error("获取点数据失败:", err);
          alert("获取点数据失败");
        }
      }

      // 设置选择模式 (start/end)
      function setSelectionMode(mode) {
        window.parent.postMessage(
          {
            type: "setSelectionMode",
            mode: mode,
          },
          "*"
        );

        // 移除alert提示
        // 不再显示alert提示
      }

      // 从父窗口获取坐标数据
      let receivedLat, receivedLng;
      let selectedStartPoint = null;
      let selectedEndPoint = null;

      // 添加全局变量存储标记
      let clickMarker = null;

      // 修改点击事件处理
      window.addEventListener("message", function (event) {
        if (event.data.type === "setCoordinates") {
          receivedLat = event.data.lat;
          receivedLng = event.data.lng;
          document.getElementById(
            "coordInput"
          ).value = `纬度 ${event.data.lat.toFixed(
            4
          )}, 经度 ${event.data.lng.toFixed(4)}`;

          // 移除之前的标记
          if (clickMarker) {
            window.parent.postMessage(
              {
                type: "removeMarker",
                markerId: clickMarker._leaflet_id,
              },
              "*"
            );
          }

          // 创建新标记
          clickMarker = {
            lat: event.data.lat,
            lng: event.data.lng,
            _leaflet_id: Date.now(), // 使用时间戳作为唯一ID
          };

          // 通知父窗口绘制标记
          window.parent.postMessage(
            {
              type: "addMarker",
              marker: clickMarker,
            },
            "*"
          );
        }

        // 处理点选择事件
        if (event.data.type === "pointSelected") {
          const point = event.data.point;

          if (event.data.mode === "start") {
            selectedStartPoint = point;
            document.getElementById("startNameInput").value = point.name || "";
            document.getElementById(
              "startCoordInput"
            ).value = `纬度 ${point.lat.toFixed(4)}, 经度 ${point.lon.toFixed(
              4
            )}`;

            // 切换到选择终点状态
            setSelectionMode("end");
          } else if (event.data.mode === "end") {
            selectedEndPoint = point;
            document.getElementById("endNameInput").value = point.name || "";
            document.getElementById(
              "endCoordInput"
            ).value = `纬度 ${point.lat.toFixed(4)}, 经度 ${point.lon.toFixed(
              4
            )}`;
          }
        }
      });

      // 修改取消按钮事件
      document
        .getElementById("cancelBtn")
        .addEventListener("click", function () {
          // 移除标记
          if (clickMarker) {
            window.parent.postMessage(
              {
                type: "removeMarker",
                markerId: clickMarker._leaflet_id,
              },
              "*"
            );
            clickMarker = null;
          }
          window.parent.postMessage({ type: "closeForm" }, "*");
        });

      // 完成按钮点击事件
      document
        .getElementById("submitBtn")
        .addEventListener("click", async function () {
          const featureType = document.querySelector(
            'input[name="featureType"]:checked'
          ).value;

          if (featureType === "point") {
            // 点表单提交逻辑保持不变
            const province = document.getElementById("provinceInput").value;
            const city = document.getElementById("cityInput").value;
            const note = document.getElementById("noteInput").value;

            const data = {
              lat: receivedLat,
              lon: receivedLng,
              province: province,
              name: city,
              info: note,
            };

            try {
              const response = await fetch(
                "https://webgisproject.onrender.com/addtravelpoints",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(data),
                }
              );

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                  `服务器返回错误: ${response.status} - ${errorText}`
                );
              }

              const result = await response.json();
              alert("添加成功！ID: " + result.gid);

              // 通知父窗口刷新页面
              window.parent.postMessage(
                {
                  type: "reloadParentPage",
                },
                "*"
              );

              window.parent.postMessage({ type: "closeForm" }, "*");
            } catch (err) {
              console.error("API请求失败:", err);
              alert(`添加失败: ${err.message}`);
            }
          } else if (featureType === "line") {
            // 线表单提交逻辑
            if (!selectedStartPoint || !selectedEndPoint) {
              alert("请选择起点和终点");
              return;
            }

            const startName = document.getElementById("startNameInput").value;
            const endName = document.getElementById("endNameInput").value;

            const lineData = {
              start: startName,
              end: endName,
              lon1: selectedStartPoint.lon,
              lat1: selectedStartPoint.lat,
              lon2: selectedEndPoint.lon,
              lat2: selectedEndPoint.lat,
            };

            try {
              const response = await fetch(
                "https://webgisproject.onrender.com/addtravelroute",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(lineData),
                }
              );

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                  `服务器返回错误: ${response.status} - ${errorText}`
                );
              }

              const result = await response.json();
              alert("路线添加成功！ID: " + result.gid);

              // 通知父窗口刷新页面
              window.parent.postMessage(
                {
                  type: "reloadParentPage",
                },
                "*"
              );

              window.parent.postMessage({ type: "closeForm" }, "*");
            } catch (err) {
              console.error("API请求失败:", err);
              alert(`路线添加失败: ${err.message}`);
            }
          }
        });

      // 取消按钮点击事件
      document
        .getElementById("cancelBtn")
        .addEventListener("click", function () {
          // 取消按钮点击事件
          document
            .getElementById("cancelBtn")
            .addEventListener("click", function () {
              // 移除标记
              if (clickMarker) {
                window.parent.postMessage(
                  {
                    type: "removeMarker",
                    markerId: clickMarker._leaflet_id,
                  },
                  "*"
                );
                clickMarker = null;
              }
              window.parent.postMessage({ type: "closeForm" }, "*");
            });
        });
    </script>
  </body>
</html>
