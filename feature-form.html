<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
        #feature-form {
            position: absolute; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); padding: 15px;
            box-sizing: border-box; display: flex; flex-direction: column;
        }
        .form-group { margin-bottom: 10px; flex: 1; display: flex; flex-direction: column; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #333; font-weight: bold; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 8px; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 4px; font-size: 13px;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: #12513D; outline: none; }
        .form-group textarea { height: 60px; resize: none; }
        
        .type-selector { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; }
        .type-selector label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        
        .form-buttons { display: flex; gap: 10px; margin-top: 5px; }
        .form-buttons button {
            flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .submit-btn { background: #12513D; color: white; }
        .submit-btn:hover { background: #0c3a2a; }
        .cancel-btn { background: #eee; color: #333; }
        .cancel-btn:hover { background: #ddd; }
    </style>
</head>
<body>
    <div id="feature-form">
        <div class="type-selector">
            <label><input type="radio" name="featureType" value="point" checked> 点</label>
            <label><input type="radio" name="featureType" value="line"> 线</label>
        </div>

        <div id="pointForm">
            <div class="form-group">
                <label>坐标：</label>
                <input type="text" id="coordInput" readonly placeholder="请在地图上点击...">
            </div>
            <div class="form-group">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>省份：</label>
                        <input type="text" id="provinceInput" placeholder="例如：湖北">
                    </div>
                    <div style="flex: 1;">
                        <label>城市：</label>
                        <input type="text" id="cityInput" placeholder="例如：武汉">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>备注：</label>
                <textarea id="noteInput" placeholder="输入足迹故事..."></textarea>
            </div>
        </div>

        <div id="lineForm" style="display: none;">
            <div class="form-group">
                <label>起点：</label>
                <input type="text" id="startNameInput" placeholder="起点名称">
            </div>
            <div class="form-group">
                <label>终点：</label>
                <input type="text" id="endNameInput" placeholder="终点名称">
            </div>
            <p style="font-size:12px; color:orange; text-align:center;">* 线功能暂未连接后端</p>
        </div>

        <div class="form-buttons">
            <button class="submit-btn" id="submitBtn">完成</button>
            <button class="cancel-btn" id="cancelBtn">取消</button>
        </div>
    </div>

    <script>
        // ================= 配置区域 =================
        // 务必确认这个地址和 map-container.html 里的一致
        const RENDER_HOST = "https://webgisproject.onrender.com"; 
        // ===========================================

        let currentUser = '访客'; // 默认
        let receivedLat = null;
        let receivedLng = null;

        // 1. 监听来自地图的消息
        window.addEventListener('message', function(event) {
            // 接收坐标
            if(event.data.type === 'setCoordinates') {
                receivedLat = event.data.lat;
                receivedLng = event.data.lng;
                document.getElementById('coordInput').value = 
                    `纬度 ${receivedLat.toFixed(4)}, 经度 ${receivedLng.toFixed(4)}`;
            }
            // 接收当前用户身份
            if(event.data.type === 'setOwner') {
                currentUser = event.data.owner;
                console.log("表单已获取身份:", currentUser);
            }
        });

        // 2. 提交按钮逻辑
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const featureType = document.querySelector('input[name="featureType"]:checked').value;
            
            if(featureType === 'point') {
                // 校验
                if (receivedLat === null || receivedLng === null) {
                    alert('请先在地图上点击选择位置！');
                    return;
                }
                const city = document.getElementById('cityInput').value;
                if (!city) {
                    alert('请输入城市名称！');
                    return;
                }

                const province = document.getElementById('provinceInput').value;
                const note = document.getElementById('noteInput').value;
                
                // 构造数据
                const data = {
                    lat: receivedLat,
                    lon: receivedLng,
                    province: province,
                    name: city,
                    info: note,
                    owner: currentUser // 关键：带上记录人
                };

                try {
                    // 发送请求到 Render
                    const response = await fetch(`${RENDER_HOST}/addtravelpoints`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`服务器错误: ${response.status} - ${errorText}`);
                    }

                    alert('添加成功！');
                    
                    // 通知父窗口刷新地图并关闭表单
                    window.parent.postMessage({ type: 'reloadParentPage' }, '*');
                    
                } catch (err) {
                    console.error(err);
                    alert(`添加失败: ${err.message}\n请检查后端是否启动。`);
                }
            } else {
                alert("线功能开发中...");
            }
        });

        // 3. 取消按钮
        document.getElementById('cancelBtn').addEventListener('click', function() {
            window.parent.postMessage({ type: 'closeForm' }, '*');
        });

        // 4. 类型切换
        document.querySelectorAll('input[name="featureType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isLine = this.value === 'line';
                document.getElementById('pointForm').style.display = isLine ? 'none' : 'block';
                document.getElementById('lineForm').style.display = isLine ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
